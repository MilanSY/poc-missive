<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>POC Missive</title>
    <script src="https://integrations.missiveapp.com/missive.js"></script>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            padding: 15px;
            background: #f9f9f9;
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }

        .log {
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="status" id="status">üîÑ En attente de Missive...</div>
        <div id="client-info">S√©lectionnez une conversation dans Missive.</div>
        <hr>
        <button onclick="testerManuel()">Forcer la lecture</button>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const infoEl = document.getElementById('client-info');
        const logEl = document.getElementById('debug-log');

        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerText += `\n[${timestamp}] ${msg}`;
            console.log(msg);
        }

        // Initialisation
        log("üöÄ D√©marrage de l'int√©gration Missive...");

        // Fonction pour obtenir l'email et les infos du contact
        function getContactInfo(conversation) {
            // Essayer de r√©cup√©rer l'email depuis diff√©rentes sources
            let email = null;
            let name = null;

            // 1. Depuis le contact s'il existe
            if (conversation.contact) {
                email = conversation.contact.emails?.[0] || null;
                name = conversation.contact.name || null;
            }

            // 2. Depuis le dernier message
            if (!email && conversation.messages && conversation.messages.length > 0) {
                const latestMsg = conversation.messages[conversation.messages.length - 1];
                if (latestMsg.from_field) {
                    email = latestMsg.from_field.address;
                    name = latestMsg.from_field.name;
                }
            }

            // 3. Depuis les participants
            if (!email && conversation.participants && conversation.participants.length > 0) {
                const participant = conversation.participants[0];
                email = participant.email || participant.address;
                name = participant.name;
            }

            return { email, name };
        }

        // √âcouter les changements de conversation (nouvelle API)
        Missive.on('change:conversations', (payload) => {
            log("üì® √âv√©nement 'change:conversations' re√ßu");
            log("Payload: " + JSON.stringify(payload, null, 2));
            updateDisplay(payload);
        });

        function updateDisplay(payload) {
            if (payload && payload.conversations && payload.conversations.length > 0) {
                const conv = payload.conversations[0];
                log("üìã Conversation ID: " + conv.id);

                const { email, name } = getContactInfo(conv);

                if (email || name) {
                    statusEl.innerText = "‚úÖ Connect√© √† Missive";
                    statusEl.style.color = "green";
                    infoEl.innerHTML = `
                        <strong>Client:</strong> ${name || 'Non sp√©cifi√©'}<br>
                        <strong>Email:</strong> ${email || 'Non trouv√©'}<br>
                        <strong>Conversation ID:</strong> ${conv.id}<br>
                        <strong>Sujet:</strong> ${conv.subject || 'Sans sujet'}
                    `;
                    log("‚úÖ Informations affich√©es");
                } else {
                    log("‚ö†Ô∏è Aucun email trouv√© dans cette conversation");
                    infoEl.innerHTML = `
                        <strong>Conversation ID:</strong> ${conv.id}<br>
                        <em>Aucune information de contact disponible</em>
                    `;
                }
            } else {
                log("‚ö†Ô∏è Payload vide ou sans conversations");
            }
        }

        function testerManuel() {
            log("üîç Test manuel lanc√©...");
            // Utilise la nouvelle API pour r√©cup√©rer le contexte
            Missive.fetchConversations().then((conversations) => {
                log("‚úÖ fetchConversations r√©ponse: " + JSON.stringify(conversations, null, 2));
                updateDisplay({ conversations });
            }).catch(err => {
                log("‚ùå Erreur fetchConversations: " + err.message);
                console.error(err);
            });
        }

        // Charger automatiquement au d√©marrage
        log("üì° Tentative de chargement initial...");
        setTimeout(() => {
            testerManuel();
        }, 500);
    </script>
</body>

</html>