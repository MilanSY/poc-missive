<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>POC Missive</title>
    <script src="https://integrations.missiveapp.com/missive.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #f9f9f9; }
        .card { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status { font-weight: bold; color: #007bff; margin-bottom: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; cursor: pointer; }
        .log { font-size: 10px; color: #666; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="card">
        <div class="status" id="status">ðŸ”„ En attente de Missive...</div>
        <div id="client-info">SÃ©lectionnez une conversation dans Missive.</div>
        <hr>
        <button onclick="testerManuel()">Forcer la lecture</button>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const infoEl = document.getElementById('client-info');
        const logEl = document.getElementById('debug-log');

        function log(msg) {
            logEl.innerText += "\n" + msg;
            console.log(msg);
        }

        // 1. Initialisation
        log("Initialisation du script...");

        // 2. Ã‰couter les changements de conversation
        Missive.on('change', (payload) => {
            log("Ã‰vÃ©nement 'change' reÃ§u");
            updateDisplay(payload);
        });

        function updateDisplay(payload) {
            if (payload && payload.conversations && payload.conversations.length > 0) {
                const conv = payload.conversations[0];
                const email = conv.latest_message ? conv.latest_message.from_field.address : "Email non trouvÃ©";
                
                statusEl.innerText = "âœ… ConnectÃ© Ã  Missive";
                statusEl.style.color = "green";
                infoEl.innerHTML = `
                    <strong>Client :</strong> ${email}<br>
                    <strong>ID :</strong> ${conv.id}
                `;
                log("DonnÃ©es mises Ã  jour pour : " + email);
            } else {
                log("Payload reÃ§u mais vide.");
            }
        }

        function testerManuel() {
            log("Test manuel lancÃ©...");
            // Demande explicitement le contexte actuel Ã  Missive
            Missive.fetchContext().then((payload) => {
                log("RÃ©ponse fetchContext reÃ§ue");
                updateDisplay(payload);
            }).catch(err => {
                log("Erreur fetchContext: " + err);
            });
        }
    </script>
</body>
</html>
