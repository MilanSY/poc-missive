<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>POC Missive</title>
    <script src="https://integrations.missiveapp.com/missive.js"></script>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            padding: 15px;
            background: #f9f9f9;
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }

        .log {
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="status" id="status">üîÑ En attente de Missive...</div>
        <div id="client-info">S√©lectionnez une conversation dans Missive.</div>
        <hr>
        <button onclick="testerManuel()">Forcer la lecture</button>
        <div class="log" id="debug-log"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const infoEl = document.getElementById('client-info');
        const logEl = document.getElementById('debug-log');

        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerText += `\n[${timestamp}] ${msg}`;
            console.log(msg);
        }

        // R√©cup√©ration du token depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        log("üöÄ D√©marrage de l'int√©gration Missive...");
        log("üîë Token d√©tect√©: " + (token ? "Oui (" + token.substring(0, 10) + "...)" : "‚ö†Ô∏è NON - PROBL√àME!"));
        log("üìç URL compl√®te: " + window.location.href);

        // Initialiser Missive avec le token
        if (token) {
            Missive.initialize({ token: token });
            log("‚úÖ Missive initialis√© avec le token");
        } else {
            log("‚ùå ERREUR: Aucun token trouv√© dans l'URL!");
            log("üí° Configurez l'URL dans Missive comme: https://votre-url.vercel.app?token={{token}}");
            statusEl.innerText = "‚ùå Configuration incorrecte";
            statusEl.style.color = "red";
            infoEl.innerHTML = `
                <strong>Erreur:</strong> Token manquant<br>
                <em>Configurez l'URL dans Missive avec ?token={{token}}</em>
            `;
        }

        // Fonction pour obtenir l'email et les infos du contact
        function getContactInfo(conversation) {
            // Essayer de r√©cup√©rer l'email depuis diff√©rentes sources
            let email = null;
            let name = null;

            // 1. Depuis le contact s'il existe
            if (conversation.contact) {
                email = conversation.contact.emails?.[0] || null;
                name = conversation.contact.name || null;
            }

            // 2. Depuis le dernier message
            if (!email && conversation.messages && conversation.messages.length > 0) {
                const latestMsg = conversation.messages[conversation.messages.length - 1];
                if (latestMsg.from_field) {
                    email = latestMsg.from_field.address;
                    name = latestMsg.from_field.name;
                }
            }

            // 3. Depuis les participants
            if (!email && conversation.participants && conversation.participants.length > 0) {
                const participant = conversation.participants[0];
                email = participant.email || participant.address;
                name = participant.name;
            }

            return { email, name };
        }

        // √âcouter les changements de conversation (nouvelle API)
        Missive.on('change:conversations', (conversations) => {
            log("üì® √âv√©nement 'change:conversations' re√ßu");
            log("Conversations brutes: " + JSON.stringify(conversations, null, 2));
            updateDisplay(conversations);
        });

        function updateDisplay(conversations) {
            // V√©rifier si on a des conversations valides
            if (!conversations || conversations.length === 0) {
                log("‚ö†Ô∏è Aucune conversation");
                statusEl.innerText = "‚è∏Ô∏è En attente de Missive...";
                statusEl.style.color = "#007bff";
                infoEl.innerHTML = "S√©lectionnez une conversation dans Missive.";
                return;
            }

            // Filtrer les conversations null
            const validConversations = conversations.filter(c => c !== null && c !== undefined);

            if (validConversations.length === 0) {
                log("‚ö†Ô∏è Toutes les conversations sont null");
                statusEl.innerText = "‚è∏Ô∏è En attente de Missive...";
                statusEl.style.color = "#007bff";
                infoEl.innerHTML = "S√©lectionnez une conversation dans Missive.";
                return;
            }

            const conv = validConversations[0];
            log("üìã Conversation trouv√©e:");
            log("  ID: " + conv.id);
            log("  Subject: " + (conv.subject || 'Sans sujet'));
            log("  Objet complet: " + JSON.stringify(conv, null, 2));

            const { email, name } = getContactInfo(conv);

            statusEl.innerText = "‚úÖ Connect√© √† Missive";
            statusEl.style.color = "green";

            infoEl.innerHTML = `
                <strong>Client:</strong> ${name || 'Non sp√©cifi√©'}<br>
                <strong>Email:</strong> ${email || 'Non trouv√©'}<br>
                <strong>Conversation ID:</strong> ${conv.id}<br>
                <strong>Sujet:</strong> ${conv.subject || 'Sans sujet'}
            `;

            if (email) {
                log("‚úÖ Email trouv√©: " + email);
            } else {
                log("‚ö†Ô∏è Aucun email trouv√© dans cette conversation");
            }
        }

        function testerManuel() {
            log("üîç Test manuel lanc√©...");
            // Utilise la nouvelle API pour r√©cup√©rer le contexte
            Missive.fetchConversations().then((conversations) => {
                log("‚úÖ fetchConversations r√©ponse:");
                log("  Type: " + typeof conversations);
                log("  Length: " + (conversations ? conversations.length : 'null'));
                log("  Contenu: " + JSON.stringify(conversations, null, 2));
                updateDisplay(conversations);
            }).catch(err => {
                log("‚ùå Erreur fetchConversations: " + err.message);
                statusEl.innerText = "‚ùå Erreur de connexion";
                statusEl.style.color = "red";
                console.error(err);
            });
        }

        // Charger automatiquement au d√©marrage
        log("üì° Tentative de chargement initial...");
        setTimeout(() => {
            testerManuel();
        }, 500);
    </script>
</body>

</html>